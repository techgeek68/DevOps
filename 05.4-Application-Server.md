# Application Servers & Apache Tomcat

---

**What is an Application Server?**
- An application server is a software platform providing runtime services for dynamic application code (e.g., Java Servlets, JSP, WebSocket endpoints, REST APIs). It abstracts:
  - Business logic execution (transactions, security integration)
  - Resource management (thread pools, connection pools, clustering hooks)
  - Standard APIs (Servlet, JSP, WebSocket, Expression Language; in full Java/Jakarta EE servers: JPA, JMS, CDI, JTA)
  - Deployment model (WAR, EAR, exploded or packaged)

Examples (lightweight vs. full profile):
- Lightweight / Servlet containers: Apache Tomcat, Jetty, Undertow
- Full Jakarta EE / Enterprise: WildFly, Payara, WebLogic, WebSphere

**Web Server vs. Application Server**

| Feature        | Web Server (HTTPD, Nginx)                        | Application Server (Tomcat, WildFly)                |
|----------------|--------------------------------------------------|-----------------------------------------------------|
| Primary Role   | Static content, reverse proxy, TLS termination   | Dynamic request execution (Servelts/JSP), APIs      |
| Execution Model| File streaming                                   | Managed components (Servlet lifecycle)              |
| Protocols      | HTTP/HTTPS (+ optional FastCGI, gRPC proxy)      | HTTP/HTTPS + implementation of Jakarta EE APIs      |
| Caching        | Strong static cache, edge friendliness           | Caches objects in heap (depends on app design)      |
| Scaling        | Horizontal (stateless)                           | Horizontal + session handling (sticky or replicated)|
| Use Case       | Front tier, static, proxy, load balancing        | Backend dynamic logic                               |

> Web servers specialise in efficient HTTP request handling and static file delivery; application servers host and execute code that renders dynamic responses.

---

**Apache Tomcat**

**What is Tomcat?**
  - Open-source Java Servlet/JSP container
  - Implements: Servlet, JSP, WebSocket, EL, annotations
  - Not a full Jakarta EE stack (no built-in EJB/JPA/JMS/JTA); integrate frameworks (Spring, Hibernate) at app layer

**Core Internal Components**
  - Coyote: Protocol handler (HTTP/1.1, HTTP/2 with upgrade, AJP if enabled)
  - Catalina: Servlet container (deployment, lifecycle, mapping, filters)
  - Jasper: JSP compiler (JSP→Java servlet class→bytecode)
  - Realm: Authentication/authorisation integration (MemoryRealm, JDBCRealm, JNDIRealm)
  - Connectors: Network endpoints (HTTP, HTTPS, AJP)
  - Executor: Shared thread pool (optional) for connectors & servlet threads

**Request Flow**
```
Client → Connector (Coyote) → Catalina Mapping → Filter Chain → Servlet/JSP → Response Commit → Output via Coyote
```

 - Tomcat Request Handling:
```
+-------------------------------+      +-------------------------------+      +--------------------------------+
|      Client (Browser)         |<---->|  Coyote (HTTP connector)      |<---->|   Servlet engine (Catalina)    |
|  HTTP request                 |      |  Acceptor threads             |      |  Servlets/JSP processing       |
|  HTTP response                |      |  Worker threads               |      |                                |
|                               |      |  SSL/TLS encryption (if HTTPS)|      |                                |
+-------------------------------+      +-------------------------------+      +--------------------------------+
                                                                                 |                           |
                                                                                 |                           |
                                                                                 v                           v
                                                                                +-------------------------------+
                                                                                | Jasper                        |
                                                                                | (JSP engine, if JSP)          |
                                                                                | JSP compilation (if JSP file) |
                                                                                | and Java bytecode delivery    |
                                                                                | for Catalina processing       |
                                                                                +-------------------------------+
```
  - Client (Browser): sends HTTP request, receives HTTP response.
  - Coyote (HTTP Connector): Listens for incoming connections, SSL/TLS support, and hands requests to Catalina.
  - Catalina (Servlet Engine): manages Servlet lifecycle; delegates JSPs to Jasper.
  - Jasper (JSP Engine): compiles JSPs to Servlets (bytecode) returned to Catalina.

---

**Environment & Prerequisites**

| Item            | Recommendation |
|-----------------|----------------|
| OS              | RHEL / CentOS / Rocky / AlmaLinux / Debian / Ubuntu |
| Java Version    | Use latest LTS (e.g., OpenJDK 21) |
| User Separation | Run Tomcat as non-root (e.g., `tomcat` user) |
| Firewall        | Restrict inbound to required ports only |
| SELinux/AppArmor| Configure policies rather than disabling |


- Set hostname:
```
 sudo hostnamectl set-hostname tomcatserver.devopsclass.com
 sudo exec bash
```

- Configure network:
```
  nmtui
```

- Install Java (RHEL family):
```
# Install Java 17 first (Debian/Ubuntu)
sudo apt update
sudo apt install -y openjdk-17-jdk

# Or on RHEL/CentOS:
sudo dnf install java-*-openjdk-devel
```

- Verify:
```
java -version
```

- Recommended Variables (add to `.bashrc` or system profile):
```
export JAVA_HOME=/usr/lib/jvm/java-21-openjdk
export CATALINA_HOME=/opt/tomcat
export PATH=$PATH:$CATALINA_HOME/bin
```

**Or** Create aliases:
```
vim ~/.bashrc
```
Add:
```
alias startup='/home/cnode/apache-tomcat-9.0.106/bin/startup.sh'
alias shutdown='/home/cnode/apache-tomcat-9.0.106/bin/shutdown.sh'
```

---

**Install Tomcat**:

| Methods         | Pros | Cons |
|----------------|------|------|
| tar.gz manual  | Full control, multiple versions side-by-side | Manual updates, no automatic service management |
| OS packages    | Easy updates via package manager | Might lag latest upstream, opinionated paths |
| Container image| Fast portability, immutable layering | Requires container orchestration hygiene |
| Configuration mgmt (Ansible) | Repeatable, versionable | Setup complexity |


**Transfer a previously downloaded archive:**
```
  scp <apache-tomcat.tar.gz> user_name@<IP_Addr>:/opt
```

**tar.gz Manual Install**
  - Visit [Apache Tomcat](https://tomcat.apache.org/) to find a download link.
    
<img width="1446" height="567" alt="Screenshot 2025-11-20 at 12 48 16 PM" src="https://github.com/user-attachments/assets/8fc7e1c4-c8fb-4904-bc85-36db28486fa5" />

```
# Download Tomcat
cd /tmp
sudo wget https://dlcdn.apache.org/tomcat/tomcat-11/v11.0.14/bin/apache-tomcat-11.0.14.tar.gz

# Extract
sudo tar -xzf apache-tomcat-11.0.14.tar.gz

# Move to /opt
sudo mv apache-tomcat-11.0.14 /opt/tomcat
```
```
sudo groupadd tomcat
sudo useradd -g tomcat -d /opt/tomcat -s /sbin/nologin tomcat
sudo chown -R tomcat:tomcat /opt/tomcat
```

  - Set Executable Permissions for bin/ Scripts
```
sudo chmod +x /opt/tomcat/bin/*.sh
```

  - Directory Layout
```
sudo tree /opt/tomcat
```
```
/opt/tomcat            (CATALINA_HOME)
/opt/tomcat/conf       (server.xml, web.xml)
/opt/tomcat/logs
/opt/tomcat/webapps    (deployed WARs)
/opt/tomcat/temp
/opt/tomcat/work       (JSP compilation)
/opt/tomcat/lib        (shared libs if needed)
```
> Avoid modifying default `webapps` for production; deploy only required WARs. Remove sample apps (docs, examples, manager) when not needed.

---

**Running Tomcat**
- Start Tomcat:
```
sudo /opt/tomcat/bin/startup.sh
```

- Check port (default 8080):
```
  netstat -tnl | grep 8080
```

<img width="988" height="237" alt="Screenshot 2025-11-20 at 1 20 56 PM" src="https://github.com/user-attachments/assets/00ac68c2-cdb5-40ba-bfa6-d45e125839ab" />


- Stop Tomcat:
```
sudo /opt/tomcat/bin/shutdown.sh
```


**Make it persistent**

1. rc.local
   rc.local is a traditional Linux script that runs at the end of the boot process, once most other system services have been launched. A very simple way for system administrators to add startup tasks, though on modern systems, this facility is replaced by systemd services.
> Note: rc.local must exist and be executable.

```
vim /etc/rc.d/rc.local
```

- Add full path to startup script:
```
sudo /opt/bin/startup.sh
```

<img width="743" height="268" alt="Screenshot 2025-11-21 at 7 47 33 AM" src="https://github.com/user-attachments/assets/836b8ea6-aada-463b-9f03-f8ffb05331ab" />

- Permissions:
```
sudo chmod u+x /etc/rc.d/rc.local
```

2. systemd Service (Preferred over rc.local)
  - Stop any manually started Tomcat
```
sudo -u tomcat /opt/tomcat/bin/catalina.sh stop || true
# If still running:
ps -ef | grep java | grep tomcat
sudo pkill -u tomcat java || true
```

  - Ensure temp directory clean:
```
sudo rm -f /opt/tomcat/temp/tomcat.pid
sudo mkdir -p /opt/tomcat/temp
sudo chown tomcat:tomcat /opt/tomcat/temp
```

  - Apply SELinux context to the entire Tomcat tree
```
sudo semanage fcontext -a -t bin_t "/opt/tomcat/bin(/.*)?"
sudo semanage fcontext -a -t usr_t "/opt/tomcat/(conf|lib|webapps|logs|temp|work)(/.*)?"
sudo restorecon -Rv /opt/tomcat
```
  
  - Create an environment file
```
sudo tee /etc/default/tomcat <<EOF
JAVA_HOME=${JAVA_HOME}
CATALINA_HOME=/opt/tomcat
CATALINA_BASE=/opt/tomcat
CATALINA_PID=/opt/tomcat/temp/tomcat.pid
CATALINA_OPTS=-Xms256m -Xmx512m -XX:+UseG1GC -Djava.security.egd=file:/dev/urandom
EOF
```

  - Create a minimal unit file
```
sudo tee /etc/systemd/system/tomcat.service <<'EOF'
[Unit]
Description=Apache Tomcat 11 Servlet Container
After=network.target

[Service]
Type=forking
User=tomcat
Group=tomcat
EnvironmentFile=-/etc/default/tomcat

# Pre-step: ensure temp directory exists
ExecStartPre=/usr/bin/mkdir -p /opt/tomcat/temp
ExecStartPre=/usr/bin/chown tomcat:tomcat /opt/tomcat/temp

ExecStart=/opt/tomcat/bin/catalina.sh start
ExecStop=/opt/tomcat/bin/catalina.sh stop

Restart=on-failure
RestartSec=5
UMask=0027
LimitNOFILE=65536
PrivateTmp=true
NoNewPrivileges=true

[Install]
WantedBy=multi-user.target
EOF
```

- Reload and start:
```
sudo systemd-analyze verify /etc/systemd/system/tomcat.service      #Check syntax

sudo systemctl daemon-reload
sudo systemctl start tomcat
sudo systemctl status tomcat
```

---

**Changing Tomcat default Port**
  - Check if the desired port (e.g., 5080) is free:
```
netstat -tnl | grep 5080
```

- Edit server.xml:
```
cd /opt/tomcat

sudo vim conf/server.xml
```

- Find Connector and update:
```
<Connector port="5080" protocol="HTTP/1.1"
connectionTimeout="20000"
redirectPort="8443" />
```
<img width="753" height="146" alt="Screenshot 2025-11-21 at 8 08 02 AM" src="https://github.com/user-attachments/assets/f92dfb60-49f3-459f-b837-7fc5e9afbebe" />


- Set firewall:
```
firewall-cmd --permanent --add-port=5080/tcp
firewall-cmd --reload
```

---

**Secure Remote Access to Manager/Host-Manager**
  - By default, access is restricted to localhost via RemoteAddrValve.

Host Manager context.xml:
```
cd /home/cnode/apache-tomcat-9.0.106/webapps/host-manager/META-INF
vim context.xml
```
Allow a specific IP (example 10.10.5.5):
```
<Context antiResourceLocking="false" privileged="true">
  <Valve className="org.apache.catalina.valves.RemoteAddrValve"
         allow="127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1|10\.10\.5\.5" />
</Context>
```

To allow a subnet (example 192.168.1.x):
```
allow="127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1|192\.168\.1\.\d+"
```

Manager app has a similar file:
```
/home/cnode/apache-tomcat-9.0.106/webapps/manager/META-INF/context.xml
```

Note: Commenting the Valve removes IP restriction but is a security risk:
```
<!--
<Valve className="org.apache.catalina.valves.RemoteAddrValve"
       allow="127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1" />
-->
```

---

## Create Roles and Users (tomcat-users.xml)
```
cd /home/cnode/apache-tomcat-9.0.106/conf
sudo vim tomcat-users.xml
```
Add roles:
```
<role rolename="manager-gui"/>
<role rolename="manager-script"/>
<role rolename="manager-jmx"/>
<role rolename="manager-status"/>
```
Add a user and assign roles:
```
<user username="admin" password="devops"
      roles="manager-gui,manager-script,manager-jmx,manager-status"/>
```

Reload Tomcat to apply:
```
shutdown.sh
startup.sh
```

---

## Verify
Access remotely (use your server IP and port):
```
http://10.10.5.4:5080
```

Expected landing page text:
```
If you're seeing this, you've successfully installed Tomcat. Congratulations!
```

Open the Manager App and log in with the configured credentials:
```
http://10.10.5.4:5080/manager/html
```

---

## Quick Reference: Host-Manager vs Manager context.xml
- host-manager/META-INF/context.xml
  - Purpose: Configure Host Manager (manage virtual hosts).
  - Scope: Server-wide host administration.

- manager/META-INF/context.xml
  - Purpose: Configure Manager App (manage webapps).
  - Scope: Deploy/undeploy/start/stop applications; runtime controls.
