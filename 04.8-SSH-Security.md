# 14. Remote Login Using SSH, Security, and Security Hardening

---

**14.1 Configuring SSH for Secure Remote Access**

SSH (Secure Shell) is a protocol for securely accessing and managing computers over a network. It was created to replace insecure protocols like Telnet and FTP by encrypting all data.

Features:
  - Security:
    - Encrypts all communication to protect against attacks.
  - Authentication:
    - Verifies users with passwords or, more securely, cryptographic keys.
  - Default Port:
    - Operates on TCP port 22.
    
Process:
  - Open a terminal and run the command: `ssh username@server_ip`
  - Accept the server's host fingerprint on the first connection.
  - Authenticate with your password or SSH key.
  - Once connected, you can run commands on the remote machine.
  - Type exit to end the session.

Prerequisites:
- You need two systems to connect between; You can:
  - Create two VMs: `Web Server` and `Web Developer`
  - Example:
    - vm1: DevOps-Linux-CLI (IPv4: 10.10.0.5)
    - vm2: DevOps-Linux-GUI (IPv4: 10.10.0.6)
  - Or, simply create two users on one VM.

  
**A. Basic SSH Connection**

- Linux/MacOS:
  - Pre installed. Use `ssh` in the terminal.
- Windows:
  - OpenSSH (Windows 10/11), or [PuTTY](https://www.putty.org/) , [BitVise](https://bitvise.com/ssh-client) for older versions.

**Basic SSH Connection:**
- Default port (22)
```bash
  ssh username@remote_host
            or
  ssh username@server_IP 
```

- Custom port
```bash
  ssh -p <port_number> username@remote_host 
              or
  ssh -p <port_number> username@server_IP
```
<img width="942" height="405" alt="Screenshot 2025-11-04 at 7 07 49 AM" src="https://github.com/user-attachments/assets/30cef2e3-4b7c-43be-97cf-b07981464ee9" />


**SSH Server Configuration:**

`sudo vim /etc/ssh/sshd_config`

```
# Change default port
Port 7070

PermitRootLogin no              # Disables root login via SSH for better security
PasswordAuthentication no       # Disables password-based login; only key-based auth allowed
PubkeyAuthentication yes        # Enables public key authentication
AllowUsers alice bob charlie    # Only allows SSH access for specified users
MaxAuthTries 3                  # Limits authentication attempts per connection to 3
ClientAliveInterval 300         # Sends a keepalive message every 300 seconds (5 minutes)
ClientAliveCountMax 2           # Disconnects client after 2 missed keepalive responses
```
<img width="730" height="474" alt="Screenshot 2025-11-04 at 7 23 15 AM" src="https://github.com/user-attachments/assets/3a6d0707-6068-41fc-9687-c4b799e956df" />


**SELinux & Firewall Configuration**

- Register custom SSH port with SELinux
```bash
sudo semanage port -a -t ssh_port_t -p tcp 7070
```

- Firewall rules
```bash
sudo firewall-cmd --permanent --add-port=7070/tcp
sudo firewall-cmd --reload
```

- Reload the SSH service
```bash
sudo systemctl reload sshd
```

Connect:

```bash
ssh -p 7070 user@remote_host_IP
```
<img width="712" height="289" alt="Screenshot 2025-11-04 at 7 29 12 AM" src="https://github.com/user-attachments/assets/819c83b4-30cd-4590-aefd-cf36978debf7" />

---

**B. SSH Client Configuration (`~/.ssh/config`)**

The file `~/.ssh/config` lets you define shortcuts and settings for SSH connections. Each Host block creates a nickname with custom parameters like hostname, port, user, key file, or proxy settings. It simplifies commands; instead of typing long SSH options, you can just run ssh <host-alias>.

Common directives:
  - HostName
    - Actual server address
  - User
    - Login username
  - Port
    - Custom SSH port
  - IdentityFile
    - Path to private key
  - ProxyJump
    - Connect via a jump (bastion) host
  - LocalForward
    - Create a local to remote tunnel

The example shows how to use the SSH client configuration file (~/.ssh/config) to simplify and automate SSH connections, especially when you connect to multiple servers or use jump hosts.
```
Host webserver
    HostName 192.168.1.100
    User admin
    Port 7070
    IdentityFile ~/.ssh/webserver_key      #Connect to 192.168.1.100 as admin on port 7070 with key 

Host bastion
    HostName bastion.example.com
    User jumpuser
    Port 7070

Host internal-server                        #Connect to 10.0.1.50 via bastion jump host 
    HostName 10.0.1.50
    User admin
    ProxyJump bastion
    
Host db-tunnel                              #Creates a local SSH tunnel forwarding your local port 3306 to the remote database port 3306.
    HostName db.example.com
    LocalForward 3306 127.0.0.1:3306        #You can connect to your local port localhost:3306 as if you were directly connected to the remote DB server.
```

- Connect examples:
```bash
    ssh webserver
```
```bash
    ssh db-tunnel
```

---
**14.2 Key Based Authentication**

- A secure login method using a matched pair of cryptographic keys instead of a password.
  - Private Key (kept secret on your machine), it proves your identity.
  - Public Key (placed on the server), it locks a challenge that only your private key can unlock.
    
- Authentication Handshake:
  - The client attempts to connect and informs the server of the public key to use.
  - The server generates a random message and encrypts it using the user's public key.
  - This encrypted message can only be decrypted by the corresponding private key.
  - The client decrypts the message with its private key and sends a response back to the server.
  - If the response is correct, the server grants access.

- It's More Secure Than Passwords:
  - Resistant to Brute Force:
    - Private keys are long, complex, and computationally infeasible to guess.
  - No Network Transmission of Secrets:
    - The private key never leaves the client machine.
  - Can Be Further Secured:
    - The private key can be protected with a passphrase.

**Generate SSH Keys:**

  - Ed25519 (Edwards-curve Digital Signature Algorithm)
    
    - Math:
      - Elliptic Curve Cryptography (Edwards curves).
    - Key Size:
      - Small (256-bit) offering security equivalent to RSA ~3072-bit.
    - Speed:
      - Ultra fast signing, verification, and generation.
    - Safety:
      - Deterministic signatures (doesn't need a random number to sign) and constant time math (immune to timing attacks).
    - Compatibility:
      - Standard in modern tech (SSH, TLS 1.3), but may fail on very old legacy systems.
    - Example:
```bash
ssh-keygen -t ed25519 -a 100 -C "user@hostname" -f ~/.ssh/id_ed25519
```

  - RSA (Rivest-Shamir-Adleman)
    
    - Math:
      - Integer factorization.
    - Key Size:
      - Large (2048-bit or 4096-bit) for adequate security.
    - Speed:
      - Very fast verification; slow signing and key generation.
    - Safety:
      - Vulnerable to side channel attacks (timing) and poor randomness if not padded correctly.
    - Compatibility:
      - Near universal; works with all legacy hardware/software.
    - Example:
```bash
ssh-keygen -t rsa -b 4096 -C "user@hostname" -f ~/.ssh/id_rsa
```

- Options:
  - -t <type> : Key type (ed25519 recommended; RSA for legacy)
  - -b <bits> : Key size (for RSA/ECDSA, e.g., 4096)
  - -f <filename> : File to save private key
  - -C <comment> : Key comment/identifier
  - -a <rounds> : KDF rounds for passphrase hashing
  - -N <passphrase> : Set passphrase (can be empty
  - -a <rounds> : KDF rounds for passphrase hashing
  - -E <hash> : Fingerprint hash type (sha256 preferred)
  - -R <host> : Remove host from known_hosts
  - -o : Use new OpenSSH private key format
  - -p : Change key passphrase
  - -y : Print public key from private key
  - -l : Show key fingerprint
  - -i : Convert RFC4716 key to OpenSSH
  - -e : Convert OpenSSH key to RFC4716
  - -H : Hash known_hosts file
  - -q : Quiet mode (suppress output in scripts)

Key Generation Example:
```
hostname
ssh-keygen -t ed25519 -a 100 -C cnode@localhost.localdomain -f ~/.ssh/id_ed25519
```
<img width="902" height="467" alt="Screenshot 2025-11-04 at 8 26 22 AM" src="https://github.com/user-attachments/assets/3149336f-aca2-4de3-8add-866c5c6e68d7" />

**Keys Stored Location:**
- Private:
  `~/.ssh/id_ed25519`
  
- Public:
  `~/.ssh/id_ed25519.pub`
  
<img width="636" height="59" alt="Screenshot 2026-01-18 at 7 18 06 PM" src="https://github.com/user-attachments/assets/1cce7c6d-bf6f-49bb-989a-047d4def9f10" />


**Secure Key Permissions:**
```
chmod 700 ~/.ssh                       # Owner can read/write/execute; secure the .ssh directory
chmod 600 ~/.ssh/id_ed25519            # Owner can read/write; private key must be kept secret
chmod 644 ~/.ssh/id_ed25519.pub        # Owner read/write, others read; public key can be shared
chmod 644 ~/.ssh/authorized_keys       # Owner read/write, others read; allows SSH logins with listed keys
chmod 644 ~/.ssh/config                # Owner read/write, others read; SSH client configuration file
```

**SSH Agent Management**

This is a process for securely storing and managing SSH private keys in memory so you don't have to repeatedly enter your passphrase. If your key has a passphrase (which it should), you’d normally type it every time. The SSH agent remembers it for the session, so you only type it once.

Advantages:
 - Single Sign on:
   - Enter your passphrase once and SSH multiple times without retyping it.
 - Secure Storage:
   - Keeps private keys in protected memory instead of on disk.
 - Key Forwarding:
   - Lets you use your local keys when connecting through intermediate servers.
 - Multiple Key Management:
   - Easily manages different keys for different servers.

* When to Use an SSH Agent:
  * Daily SSH connections to multiple servers
  * SSH in scripts or automated processes
  * Working with Git repositories over SSH
  * Using SSH jump hosts or bastion servers

- Start agent
```bash
eval "$(ssh-agent -s)"
```

- Add key to agent
```bash
ssh-add ~/.ssh/id_ed25519
```

- List loaded keys
```bash
ssh-add -l
```

- Remove all keys
```bash
ssh-add -D
```
<img width="886" height="301" alt="Screenshot 2025-11-04 at 8 39 15 AM" src="https://github.com/user-attachments/assets/d39bfb19-2e01-43ef-8904-ffd4bcd0cc11" />


**Deploy Public Key:** 

- Automatic copy
```bash
ssh-copy-id -i ~/.ssh/id_ed25519.pub user@remote_host
```

- Manual method
```
cat ~/.ssh/id_ed25519.pub | ssh user@remote_host "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"
```

**Connect Using Key:**
```bash
ssh -i ~/.ssh/id_ed25519 username@remote_server_ip
```
Example:
<img width="1215" height="524" alt="Screenshot 2025-11-04 at 11 14 56 AM" src="https://github.com/user-attachments/assets/1141de16-a9f2-4d8a-92c8-d2250d79be33" />


**Disable Password Authentication (on server):**
  * Edit `/etc/ssh/sshd_config`:
```
PasswordAuthentication no              # Disable password logins; only allow key-based authentication
ChallengeResponseAuthentication no     # Disable keyboard-interactive authentication (e.g., one-time codes)
UsePAM no                              # Disable Pluggable Authentication Modules; improves security when only keys are used
```

- Reload SSH:
```bash
sudo systemctl reload sshd
```

---

**14.3 File Transfers Over SSH**

File transfers over SSH leverage the Secure Shell protocol to securely move files between local and remote systems, or between two remote systems. This secure method encrypts the data during transit, protecting it from unauthorized access.

**A. SCP (Secure Copy)**
  - A command line utility for copying files and directories between a local host and a remote host, or between two remote hosts.

- Local to Remote
```bash
scp file.txt user@remote:/path/
```
- Remote to Local 
```bash 
scp user@remote:/path/file.txt ./
```
- Recursive directory copy
```bash
scp -r /local/dir/ user@remote:/path/
```
- Custom SSH port
```bash
scp -P 2222 file.txt user@remote:/path/
```
- Preserve file attributes
```bash
scp -p file.txt user@remote:/path/
```

Example:

  - Create a file in VM1: `vim index.html` and transfer it to VM2


<img width="619" height="67" alt="Screenshot 2025-11-04 at 11 54 24 AM" src="https://github.com/user-attachments/assets/595fe6b5-db0d-41c3-b694-94c1fa00cef7" />


<img width="732" height="286" alt="Screenshot 2025-11-04 at 11 55 20 AM" src="https://github.com/user-attachments/assets/fcf535e0-e989-4128-911c-dd7205182db9" />


<img width="1249" height="288" alt="Screenshot 2025-11-04 at 11 57 51 AM" src="https://github.com/user-attachments/assets/b48b98e0-2710-40ef-9492-407cf947a2ca" />


**B. RSync Over SSH**

- A utility for efficiently synchronizing files and directories, especially useful for large transfers or keeping data consistent between systems.
  
- Rsync can utilize SSH for secure transport.
  
- Advantages are only transfer changes, support resume, compression, and bandwidth control
  
- Examples:
- Basic sync  
```bash
rsync -avz /local/dir/ user@remote:/remote/dir/
```

- Sync with delete (mirror)
```bash
rsync -avz --delete /local/dir/ user@remote:/remote/dir/
```

- Custom SSH port
```bash
rsync -avz -e "ssh -p 2222" /local/dir/ user@remote:/remote/dir/
```

- Partial transfers (resume)
```bash
rsync -avz --partial /large/file user@remote:/path/
```

- Bandwidth limiting
```bash
rsync -avz --bwlimit=1000 /local/ user@remote:/remote/
```

- Flags:
  - `-a`: Archive mode
  - `-v`: Verbose
  - `-z`: Compress
  - `-e`: Specify remote shell/port

Example:

<img width="752" height="609" alt="Screenshot 2025-11-04 at 12 19 39 PM" src="https://github.com/user-attachments/assets/0c350bf2-7944-4abc-b918-65bca747a644" />

<img width="493" height="241" alt="Screenshot 2025-11-04 at 12 19 50 PM" src="https://github.com/user-attachments/assets/9a89236b-2dfd-461d-889f-d30daba2f87f" />



**SSHFS (SSH Filesystem)**

 - A more feature rich file transfer protocol built on top of SSH, offering capabilities beyond simple file copying, such as listing directories, creating/deleting files, and resuming interrupted transfers.
   
 - Typically accessed through an SFTP client (e.g., FileZilla, WinSCP, or the sftp command line utility).
   
 - Mount remote directories as local filesystems, so working with remote files as if they're local

- Mount remote directory
```bash
sshfs user@remote:/remote/path /local/mountpoint -p 2222
```

- Unmount
```bash
fusermount -u /local/mountpoint
```

- Persistent mount (`/etc/fstab`)
```bash
sshfs user@remote:/path /local/mountpoint fuse.sshfs port=2222,defaults 0 0
```

Example:

 - Install `sshfs` package on both VMs
```
sudo yum install -y epel-release
sudo yum install -y sshfs
```

 - Make sure SSH is working between VM1 → VM2
   - Test SSH login (port 2222):
     ```
     ssh -p 2222 centos@192.168.1.20
     ``` 
 
 - Create a folder on VM2 to share on VM2:
```
mkdir -p /home/centos/shared
echo "This file is from VM2" > /home/centos/shared/test.txt
```

 - Create local mount point on VM1 in VM1:
```
sudo mkdir -p /mnt/vm2shared
sudo chown centos:centos /mnt/vm2shared
```

 - Mount remote directory using sshfs in VM1:
```
sshfs centos@192.168.1.20:/home/centos/shared /mnt/vm2shared -p 2222
```

 - Verify
```
ls /mnt/vm2shared
cat /mnt/vm2shared/test.txt
```

 - Unmount when it's done
```
fusermount -u /mnt/vm2shared
```

 - Make it persistent:
   
   `sudo vim /etc/fstab`
   
   `sshfs#centos@192.168.1.20:/home/centos/shared /mnt/vm2shared fuse.sshfs port=2222,defaults,_netdev 0 0`
   
 - Verify
   ```
   sudo mount -a
   ls /mnt/vm2shared
   ```

Key Differences:
  - SCP:
    - Fast for one time transfers
  - RSync:
    - Efficient for syncing large datasets
  - SSHFS:
    - Convenient for ongoing file access

---

**14.4 Security and Hardening**

**A. SSH Hardening**

- SSH hardening enhances server security by minimizing unauthorized access risks.
 - Use strong passphrases to protect SSH keys.
 - Disable root login:
   - Set `PermitRootLogin no` to prevent direct root access.
 - Use key based authentication:
   - Replace passwords with SSH keys (`PasswordAuthentication no`).
 - Limit user access:
   - Allow only specific users or groups (`AllowUsers user1 user2`).
 - Change default port:
   - Move from port 22 to a non-standard one (e.g., `Port 2222`).
 - Disable unnecessary features:
   - Turn off X11 or agent forwarding if not needed.
 - Implement rate limiting:
   - Use tools like *fail2ban* to block repeated failed attempts.
 - Keep software updated:
   - Regularly patch OpenSSH and the OS.
 - Monitor logs:
   - Check SSH logs for unusual or failed logins.
 - Use strong ciphers and MACs:
     Configure only secure cryptographic algorithms.

Example:
  `sudo vim /etc/ssh/sshd_config`
  
- Disable direct root login for security
```bash
PermitRootLogin no
```

- Change the default SSH port (optional, adds minor obscurity)
```bash
Port 2222
```

- Restrict SSH access to specific users only
```bash
AllowUsers alice bob
```
<img width="622" height="424" alt="Screenshot 2025-11-05 at 6 58 34 AM" src="https://github.com/user-attachments/assets/d43c51c0-c177-431b-bb07-cce48b0335c5" />


**SSH Hardening Script**
- Example:
```
#!/bin/bash
# ssh-hardening.sh — Harden SSH configuration for improved server security

# Backup the original SSH configuration
cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup.$(date +%Y%m%d)
echo "Backup created at /etc/ssh/sshd_config.backup.$(date +%Y%m%d)"

# Apply secure SSH settings
cat > /etc/ssh/sshd_config << 'EOF'
# --- Basic Security ---
Port 2222                        # Change default SSH port
Protocol 2                       # Use only SSH protocol version 2
PermitRootLogin no               # Disable root login
PasswordAuthentication no        # Disable password authentication
PubkeyAuthentication yes         # Enable public key authentication
AllowUsers alice bob             # Restrict login to specific users

# --- Authentication Limits ---
MaxAuthTries 3                   # Limit failed authentication attempts
LoginGraceTime 60                # Time allowed for successful login (seconds)

# --- Connection Settings ---
ClientAliveInterval 300          # Timeout interval to keep session alive
ClientAliveCountMax 2            # Disconnect after 2 missed keepalive messages

# --- Restrict Features ---
AllowTcpForwarding no            # Disable TCP forwarding
AllowAgentForwarding no          # Disable SSH agent forwarding
X11Forwarding no                 # Disable X11 forwarding (GUI)
PermitEmptyPasswords no          # Disallow empty passwords

# --- Legacy & Rhosts ---
IgnoreRhosts yes                 # Ignore ~/.rhosts files
RhostsRSAAuthentication no       # Disable rhosts-based authentication
HostbasedAuthentication no       # Disable host-based authentication

# --- Miscellaneous ---
PrintMotd no                     # Don’t print the message of the day
ChallengeResponseAuthentication no  # Disable keyboard-interactive auth
UsePAM yes                       # Use PAM for session and account management
EOF

# Reload SSH service to apply changes
systemctl reload sshd
echo "SSH hardening completed successfully."
```

**Fail2Ban Configuration (anti brute force):** 
- Fail2Ban is an intrusion prevention framework that protects servers from brute force attacks by monitoring log files for suspicious activity and automatically banning offending IP addresses using firewall rules.
- `jail.conf`:
  - `jail.conf` contains the default Fail2Ban configuration and should not be edited directly.
- `jail.local`:
  - `jail.local` is used to override or add custom configurations. Create this file if it doesn't exist:

```
# Install
sudo apt install fail2ban    # Debian/Ubuntu
sudo dnf install fail2ban    # RHEL/CentOS

# SSH jail configuration (/etc/fail2ban/jail.local)
[sshd]
enabled  = true               # Enable SSH protection
port     = 2222               # Match your custom SSH port
filter   = sshd               # Use the default SSH filter
logpath  = /var/log/auth.log  # Auth log path (check distro specific path)
maxretry = 3                  # Ban after 3 failed login attempts
findtime = 600                # Time window (seconds) for counting failures
bantime  = 3600               # Ban duration (seconds, e.g., 1 hour)


# Start and enable
sudo systemctl enable --now fail2ban
sudo fail2ban-client status sshd
```

---

**B. Firewall Configuration**

- Allow SSH (custom port):
  - `ufw` (Debian/Ubuntu)
```bash
sudo ufw allow 2222/tcp      # Allow new SSH port
sudo ufw deny 22/tcp         # Block default SSH port (22)
sudo ufw enable              # Enable UFW if not already active
sudo ufw status verbose      # Verify active rules
```
  - `firewalld` (RHEL/CentOS/Fedora)
```bash
sudo firewall-cmd --permanent --add-port=2222/tcp     # Allow custom SSH port
sudo firewall-cmd --permanent --remove-service=ssh    # Remove default SSH service (port 22)
sudo firewall-cmd --reload                            # Apply changes
sudo firewall-cmd --list-all                          # Verify rules
```

**Enforce Strong Password Policy (PAM Hardening)**

 - Enforcing strong passwords with PAM involves configuring modules like pam_pwquality or pam_passwdqc to ensure password complexity and strength.
 
 - Install Pluggable Authentication Modules (PAM) Password Quality Module
```bash
sudo apt install libpam-pwquality    # Debian/Ubuntu
sudo dnf install libpwquality        # RHEL/CentOS
```

 - Choose a module:
   - Use pam_pwquality (modern, flexible) or pam_passwdqc (alternative for some systems).
 - Edit PAM configuration:
   - Modify `/etc/pam.d/common-password` or `/etc/pam.d/system-auth` to include the chosen module (e.g., password required pam_pwquality.so).
  
 - Edit `/etc/security/pwquality.conf` and add (or update) the following
```bash
minlen = 12      # Minimum password length (12 characters)
minclass = 3     # Require at least 3 character classes (uppercase, lowercase, digits, special)
dcredit = -1     # Require at least 1 digit
ucredit = -1     # Require at least 1 uppercase letter
lcredit = -1     # Require at least 1 lowercase letter
ocredit = -1     # Require at least 1 special character
maxrepeat = 2    # Disallow more than 2 consecutive identical characters
```

**Sudo Security**
 - Sudo controls and logs elevated privileges, enhancing security by enforcing least privilege, preventing root password sharing, and reducing accidental or malicious actions.
 - Safety methods:
   - Edit safely with visudo.
   - Grant only necessary commands, avoid ALL.
   - Require passwords (NOPASSWD only if essential).
   - Limit session timeout.
   - Avoid commands that can spawn root shells.
   - Use `/etc/sudoers.d` for organized configuration.
 
- Safely Edit the sudoers File:
```bash
sudo visudo
```

- Example:
```bash
# --- User with full administrative privileges ---
alice ALL=(ALL:ALL) ALL

# --- User allowed to manage only Nginx service ---
bob ALL=(ALL) /usr/bin/systemctl restart nginx, /usr/bin/systemctl status nginx

# --- Group based administrative privileges ---
%admins ALL=(ALL) ALL

# --- Passwordless execution for specific backup operations ---
%backup ALL=(ALL) NOPASSWD: /usr/bin/rsync

# --- Log all sudo command usage for auditing ---
Defaults logfile="/var/log/sudo.log"
```

---

**Advanced Enterprise Enhancements**

**A. Bastion Host/Jump Host Setup**
  - Use a dedicated bastion host as a secure entry point to private servers in multi tier environments.
  - Restrict SSH access to production/internal servers from outside only via the bastion.
  - Harden bastion:
    - Restrict IPs, enforce key-based auth, enable logging/auditing.

- Example:
    `vim /etc/ssh/sshd_config`
  
```bash
  AllowTcpForwarding yes
  PermitTunnel yes
```
  
- Use ProxyJump/ProxyCommand in `~/.ssh/config`:
```bash
Host internal-*
    ProxyJump bastion-user@bastion-host:2222  # Route all internal-* hosts through bastion

Host internal-web
    HostName 10.0.1.10       # Internal IP of web server
    User webadmin            # Login user

Host internal-db
    HostName 10.0.1.20       # Internal IP of DB server
    User dbadmin             # Login user
```

  or
  
```bash
ssh -J bastion-user@bastion-host:2222 webadmin@10.0.1.10        # Connect to the internal web server via the bastion host
```

**B. Automated SSH Certificate Authorities (CA)**
  - Use OpenSSH CA to issue short lived certificates for users/hosts.
  - Benefits:
    - Central control, key rotation, short lived credentials.
  - Automate with Vault, Teleport, or AWS IAM SSH certificates.

- Example to sign a user key:
```bash
  # Generate a new CA key (ed25519) for signing SSH user keys
  ssh-keygen -t ed25519 -f ~/ssh-ca -C "SSH CA"

  # Sign a user's public key with 1-hour validity and allowed principals alice and bob
  ssh-keygen -s ~/ssh-ca -I user@company -n alice,bob -V +1h user-key.pub

  # Configure server to trust the CA public key
  echo "TrustedUserCAKeys /etc/ssh/ca.pub" >> /etc/ssh/sshd_config
```

**C. Multi Factor Authentication (Google Authenticator)**
```bash
# Install Google Authenticator PAM module (RHEL/CentOS/Fedora)
sudo dnf install google-authenticator -y

# Install Google Authenticator PAM module (Debian/Ubuntu)
sudo apt install libpam-google-authenticator -y

# Configure TOTP for the current user
google-authenticator                                     # Generates QR code, secret key, and recovery codes

# Enable PAM module for SSH (add to /etc/pam.d/sshd)
auth required pam_google_authenticator.so                # Require TOTP for authentication

# SSH server configuration (/etc/ssh/sshd_config)
ChallengeResponseAuthentication yes                      # Enable challenge-response (keyboard-interactive)
AuthenticationMethods publickey,keyboard-interactive     # Require both SSH key + TOTP
```

 - Restart SSH after changes:
```bash
sudo systemctl reload sshd
```

**D. Cloud Native SSH Solutions**

**AWS:**
  - Use [AWS Systems Manager Session Manager](https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager.html) for shell access with audit logs and no direct SSH port exposure.
  - Example: AWS Session Manager
```bash
# No SSH port needed - access via AWS CLI
aws ssm start-session --target instance-id

# SSH-like experience through Session Manager
aws ssm start-session --target i-1234567890abcdef0 --document-name AWS-StartSSHSession --parameters 'portNumber=22'
```


**Azure:**
  - Use [Azure Bastion](https://learn.microsoft.com/en-us/azure/bastion/bastion-overview) for secure, audited SSH/RDP.
- Example: Azure Bastion
```yaml
# ARM template snippet
{
  "type": "Microsoft.Network/bastionHosts",
  "apiVersion": "2023-05-01",
  "name": "bastion-host",
  "location": "[resourceGroup().location]",
  "properties": {
    "ipConfigurations": [{
      "name": "bastionConfig",
      "properties": {
        "subnet": {"id": "[variables('bastionSubnetId')]"},
        "publicIPAddress": {"id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('bastionPublicIpName'))]"}
      }
    }]
  }
}
```

**GCP:** 
  - Use [IAP TCP Forwarding](https://cloud.google.com/iap/docs/using-tcp-forwarding) and OS Login for SSH session logging.

---

**E. Monitoring & Auditing**
  - Install [prometheus-sshd-exporter](https://github.com/caarlos0/prometheus-sshd-exporter) or similar.
  - Exposes SSH login metrics (auth attempts, failures, active sessions).
  - Scrape with Prometheus, alert on anomalies in Grafana.
  
- Example:
  - Prometheus SSHD Exporter
```yaml
 # systemd service
[Unit]
Description=Prometheus SSH Exporter
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/sshd_exporter --web.listen-address=:9119
Restart=always

[Install]
WantedBy=multi-user.target
```

  - SSH Session Logging:
```bash
# Log all SSH commands
# Add to /etc/bashrc or /etc/profile
export PROMPT_COMMAND='history -a >(tee -a ~/.bash_history | logger -t "$USER[$PWD] $SSH_CONNECTION")'
```


---

**Security Recommendations**

| Area             | Recommendation                                                |
|------------------|-------------------------------------------------------------- |
| SSH Access       | Use key-based login, disable root, restrict allowed users     |
| Bastion/Jump     | Centralize access, use ProxyJump, audit all connections       |
| Certificates     | Issue short-lived certs, automate CA/key rotation             |
| Passwords        | Enforce strong policy, rotate regularly                       |
| Firewall         | Default-deny, open only required ports                        |
| Sudo             | Use visudo, least privilege, restrict commands/groups         |
| PAM              | Restrict sessions, enforce MFA, audit usage                   |
| Automation       | Use config management for enforcement                         |
| Monitoring       | Integrate Fail2Ban, Prometheus, audit SSH logs                |
| Key Management   | Use centralized vaults, automate rotation                     |
| Compliance       | Regular audits, SIEM integration, session logging             |


---

**Troubleshooting Common Issues**
```bash
# Debug SSH connection
ssh -vvv -p 2222 user@host

# Check key permissions
ls -la ~/.ssh/

# Verify service status
systemctl status sshd
systemctl status fail2ban

# Check logs
journalctl -u sshd --since "1 hour ago"
tail -f /var/log/auth.log

# Test firewall
nmap -p 2222 hostname
```

---

**References**

- `man ssh`, `man sshd_config`, `man scp`, `man rsync`, `man iptables`, `man visudo`
- [OpenSSH](https://www.openssh.com/manual.html)
- [PuTTY](https://www.putty.org/)
- [Fail2Ban](https://www.fail2ban.org/wiki/index.php/Main_Page)
- [pam_pwquality](https://linux.die.net/man/8/pam_pwquality)
- [Ansible SSH Hardening Role](https://github.com/dev-sec/ansible-ssh-hardening)
- [HashiCorp Vault SSH Secrets](https://developer.hashicorp.com/vault/tutorials/secrets-management/ssh-secrets)
- [AWS EC2 Key Pairs](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html)
- [Azure Key Vault](https://learn.microsoft.com/en-us/azure/key-vault/general/overview)
- [Google Authenticator PAM](https://github.com/google/google-authenticator)
- [OpenSSH Certificate Authentication](https://man.openbsd.org/ssh-keygen#CERTIFICATES)
- [Prometheus SSHD Exporter](https://github.com/caarlos0/prometheus-sshd-exporter)
- [AWS Systems Manager Session Manager](https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager.html)
- [Azure Bastion](https://learn.microsoft.com/en-us/azure/bastion/bastion-overview)
- [GCP IAP TCP Forwarding](https://cloud.google.com/iap/docs/using-tcp-forwarding)
  
---

---
